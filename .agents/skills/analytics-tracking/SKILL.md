---
name: analytics-tracking
description: GA4、GTM、Google Ads、Meta Pixel、TikTok Pixel、X Pixel、Microsoft Clarityなどの計測トラッキングを設計・設定し、GTMコンテナのインポート用JSONを出力する。ユーザーが「トラッキング設定」「GA4設定」「Google Analytics」「コンバージョントラッキング」「イベント計測」「GTM設定」「タグマネージャー」「ピクセル設定」「計測設計」「トラッキングプラン」「Clarity導入」「広告タグ設定」に言及した場合にも使用する。
---

# Analytics Tracking

GA4・GTM・各広告プラットフォームの計測設定を設計し、GTMコンテナのインポート可能なJSONファイルを出力する。

## ワークフロー

```
0. アプリコード読み込み → 1. 要件ヒアリング → 2. リファレンス参照 → 3. テンプレート選択 → 4. JSON出力 → 5. 実装ガイド
```

---

## 0. アプリケーションコードの読み込み

計測対象のサイト/アプリのソースコードがプロジェクト内（`dev/` 等）に存在する場合、**設計前に必ず読み込んで把握する。** 実コードを理解することで、dataLayer設計・トリガー条件・イベント定義の精度が大幅に向上する。

**確認すべきポイント:**
- ページ構成・ルーティング（SPA/MPA判定、主要ページの把握）
- フォーム実装（フォームID、送信処理、バリデーション）
- EC機能（カート、チェックアウト、購入完了のフロー）
- 既存の `dataLayer.push` やアナリティクス関連コード
- CTA・電話リンク・外部リンクの実装パターン
- HTMLの `data-*` 属性やクラス名（トリガー条件に使える要素）

**手順:**
1. ユーザーに対象アプリのディレクトリパスを確認
2. プロジェクト構造を把握（Glob/Grepでファイル探索）
3. 主要ページ・コンポーネントのソースを読み込む
4. 既存の計測実装があれば把握し、重複を避ける

---

## 1. 要件ヒアリング

ユーザーから以下を収集する。不明な項目は質問して確認。

| # | 項目 | 例 | 必須 |
|---|------|-----|------|
| 1 | アプリケーションのパス | `dev/my-site/` | プロジェクト内にある場合 |
| 2 | サイト種別 | コーポレート / LP / EC / リード獲得 | ✅ |
| 3 | 使用プラットフォーム | GA4, Google Ads, Meta, TikTok, X, Clarity | ✅ |
| 4 | 主要コンバージョン | 購入、フォーム送信、電話タップ等 | ✅ |
| 5 | SPA / MPA | MPA | page_view制御の判断用 |
| 6 | GTMアカウントID | `123456` | JSON生成時 |
| 7 | GTMコンテナID | `789012` | JSON生成時 |
| 8 | コンテナ公開ID | `GTM-XXXXXXX` | JSON生成時 |
| 9 | サイトドメイン | `example.com` | JSON生成時 |
| 10 | 各プラットフォームのID | GA4測定ID、Pixel ID等 | JSON生成時 |

**ヒアリングのコツ:**
- サイト種別と使用プラットフォームが分かれば設計は開始できる
- ID類はJSON出力直前に確認すればよい（プレースホルダーで先に設計可能）
- ECサイトの場合はecommerceファネル（view_item → add_to_cart → begin_checkout → purchase）の有無を確認

---

## 2. リファレンスマニュアル

各プラットフォームの詳細仕様は `references/` ディレクトリのマニュアルを参照。**ユーザーが選択したプラットフォームに関連するマニュアルのみ読み込むこと。**

| マニュアル | 内容 | 読むタイミング |
|---|---|---|
| `references/gtm.md` | GTMコンテナ設計、命名規則、JSON仕様 | **常に読む**（JSON出力の基盤） |
| `references/google-analytics.md` | GA4プロパティ設計、イベント体系、推奨イベント、ecommerce | GA4使用時 |
| `references/google-ads.md` | コンバージョン設計、拡張コンバージョン、動的リマーケティング | Google Ads使用時 |
| `references/meta-pixel.md` | 標準イベント、カスタムイベント、Conversions API | Meta使用時 |
| `references/tiktok-pixel.md` | 標準イベント、Events API、Advanced Matching | TikTok使用時 |
| `references/x-pixel.md` | 標準イベント、Conversion API | X使用時 |
| `references/microsoft-clarity.md` | ヒートマップ、セッション録画、カスタムタグ | Clarity使用時 |

---

## 3. テンプレート選択

サイト種別とプラットフォームの組み合わせに応じてベーステンプレートを選択。

| テンプレート | プラットフォーム | 適合シーン |
|---|---|---|
| `references/gtm-template-corporate.json` | GA4 + Clarity | コーポレートサイト、ホームページ |
| `references/gtm-template-lp.json` | GA4 + Clarity + Google Ads | Google Ads向けLP、リード獲得CV |
| `references/gtm-template-ec.json` | GA4 + Clarity + Google Ads | ECサイト基本（ecommerceファネル） |
| `references/gtm-template-lead-gen.json` | GA4 + Clarity + Google Ads + Meta | リード獲得、複数広告プラットフォーム |
| `references/gtm-template-ec-full.json` | GA4 + Clarity + Google Ads + Meta + TikTok + X | EC全部入り（全プラットフォーム） |

**テンプレートの使い方:**
1. 最も近いテンプレートを選択し、内容を読み込む
2. ユーザーの要件に合わせてタグ・トリガー・変数を追加/削除/修正
3. プレースホルダー（`{ACCOUNT_ID}`, `{GA4_MEASUREMENT_ID}` 等）をユーザー提供の値に置換
4. コミュニティテンプレートの `cvt_*` IDはインポート先のテンプレートIDに置換が必要（ユーザーに説明）

**テンプレートに完全一致するものがない場合:**
- 最も近いテンプレートをベースに、`gtm.md` のJSON仕様と各プラットフォームマニュアルを参照してカスタマイズ
- 新しいタグ追加時は命名規則（`gtm.md` セクション3）に従う

---

## 4. JSON出力

### カスタマイズの手順

1. **テンプレートを読み込む** → ベース構造を確認
2. **タグの追加/削除:**
   - 不要プラットフォームのタグ・変数・フォルダを削除
   - 追加コンバージョンのタグ・トリガーを追加
   - タグIDは連番で割り当て（インポート時に再採番される）
3. **トリガーの調整:**
   - カスタムイベント名をユーザーのdataLayer設計に合わせる
   - 共有トリガーは1つにまとめる（同条件の重複を避ける）
4. **変数の調整:**
   - 定数変数の値をユーザー提供のIDに置換
   - 必要なデータレイヤー変数を追加
5. **フォルダの整理:**
   - 使用プラットフォームのフォルダのみ残す
   - 新しいプラットフォーム追加時はフォルダも追加

### JSON出力時のチェック

- [ ] `exportFormatVersion: 2` がトップレベルにある
- [ ] 全タグに `firingTriggerId` が設定されている
- [ ] 組み込みトリガーID（`2147479553`, `2147479573`, `2147479583`）が正しく使用されている
- [ ] 全タグ・トリガー・変数に `parentFolderId` が設定されている
- [ ] 命名規則に従っている（タグ: `[Platform] - [Type] - [Detail]`）
- [ ] PIIがパラメータに含まれていない（電話番号、メール等）
- [ ] `tagReference` でGA4 Configタグを参照するGA4イベントタグがある場合、参照名が正しい
- [ ] コミュニティテンプレート（`cvt_*`）使用箇所にはユーザーへの置換案内を添える

---

## 5. 実装ガイド

JSON出力後、ユーザーに以下を案内する。

### GTMインポート手順
1. GTM管理画面 → 管理 → コンテナのインポート
2. 生成したJSONファイルを選択
3. 新規コンテナなら「上書き」、既存なら「統合」を選択
4. コミュニティテンプレートタグがある場合は、先にテンプレートギャラリーからインストール

### dataLayer実装
- アプリケーション側で必要な `dataLayer.push` コードを提示
- イベント名とパラメータの仕様を明示

### 検証手順
1. GTMプレビューモードで全タグの発火確認
2. GA4 DebugViewでイベント受信確認
3. 各プラットフォームのヘルパーツール（Meta Pixel Helper等）で確認
4. PIIがイベントに含まれていないことを確認
5. 問題なければバージョン名と説明を記載して公開
